<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Главная панель ГИБДД</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Подключение Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Глобальные переменные Canvas, предоставляемые средой
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            if (authToken) {
                signInWithCustomToken(window.auth, authToken);
            } else {
                signInAnonymously(window.auth);
            }
        }

        // Экспортируем функции для доступа из других скриптов
        window.firestore = {
            onSnapshot,
            collection,
            query,
            addDoc,
            getDocs,
            deleteDoc
        };

        console.log("Firebase initialized and ready to use.");
    </script>
    <style>
        .sidebar {
            width: 250px;
            min-height: 100vh;
            transition: all 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .sidebar:hover {
                width: 250px;
            }
            .sidebar .nav-text {
                display: none;
            }
            .sidebar:hover .nav-text {
                display: inline;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex font-sans text-gray-800">

    <!-- Боковое навигационное меню -->
    <aside class="sidebar bg-gray-900 text-white p-6 shadow-lg rounded-r-2xl">
        <div class="flex items-center mb-8">
            <i class="fas fa-traffic-light text-3xl text-yellow-500 mr-3"></i>
            <h1 class="text-2xl font-bold nav-text">ГИБДД ОРЛС</h1>
        </div>
        <nav>
            <ul class="space-y-4">
                <li data-role="all">
                    <a href="main.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-home text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Главная</span>
                    </a>
                </li>
                <li data-role="deputy_head">
                    <a href="employee_management.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-users text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Управление сотрудниками</span>
                    </a>
                </li>
                <li data-role="all">
                    <a href="formations.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-chess-knight text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Управление строями</span>
                    </a>
                </li>
                <li data-role="all">
                    <a href="candidates.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-user-tie text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Кандидаты в начальники</span>
                    </a>
                </li>
                <li data-role="all">
                    <a href="orls_reports.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-file-invoice text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Отчетность ОРЛС</span>
                    </a>
                </li>
                <li data-role="deputy_head">
                    <a href="orls_reports_form.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-chart-line text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Сформировка отчетов</span>
                    </a>
                </li>
                <li data-role="deputy_head">
                    <a href="tools.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-toolbox text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Управление инструментами</span>
                    </a>
                </li>
                <li data-role="all">
                    <a href="attestation.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-clipboard-check text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Прохождение аттестации</span>
                    </a>
                </li>
                <li data-role="senior_instructor">
                    <a href="attestation_results.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-poll text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Результаты аттестации</span>
                    </a>
                </li>
                <li data-role="deputy_head">
                    <a href="attestation_reset.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-undo-alt text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Обнуление аттестации</span>
                    </a>
                </li>
                 <li data-role="all">
                    <a href="reattestation.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-sync-alt text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Переаттестации</span>
                    </a>
                </li>
                 <li data-role="all">
                    <a href="add_attestation.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-plus-circle text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Аттестации</span>
                    </a>
                </li>
                <li data-role="all">
                    <a href="information_department.html" class="flex items-center py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i class="fas fa-info-circle text-xl mr-4"></i>
                        <span class="font-semibold nav-text">Информационный отдел</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Основное содержимое панели -->
    <main class="main-content flex-grow p-8">
        <div class="container mx-auto">
            <div class="bg-white rounded-3xl shadow-lg p-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-4xl font-bold text-gray-900">Добро пожаловать</h2>
                </div>
                <p class="text-lg text-gray-600 mb-6">
                    Это центральная панель для управления всеми ключевыми процессами. Используйте навигационное меню слева, чтобы перейти в нужный раздел.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- Карточки, которые будут динамически скрываться/отображаться -->
                    <a href="main.html" data-role-card="all" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-6 rounded-2xl shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-home text-3xl mb-4"></i>
                        <h3 class="text-xl">Главная</h3>
                        <p class="text-sm opacity-80">Просмотр ближайших строев и доступных кнопок.</p>
                    </a>

                    <a href="employee_management.html" data-role-card="deputy_head" class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-6 rounded-2xl shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-users text-3xl mb-4"></i>
                        <h3 class="text-xl">Управление сотрудниками</h3>
                        <p class="text-sm opacity-80">Просмотр и редактирование данных сотрудников, включая таблицу штата.</p>
                    </a>
                    
                    <a href="attestation.html" data-role-card="all" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-6 rounded-2xl shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-clipboard-check text-3xl mb-4"></i>
                        <h3 class="text-xl">Прохождение аттестации</h3>
                        <p class="text-sm opacity-80">Перейти к сдаче аттестационного теста.</p>
                    </a>

                    <a href="orls_reports.html" data-role-card="all" class="bg-green-500 hover:bg-green-600 text-white font-bold p-6 rounded-2xl shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-file-invoice text-3xl mb-4"></i>
                        <h3 class="text-xl">Отчетность ОРЛС</h3>
                        <p class="text-sm opacity-80">Подача и одобрение отчетов и неактива.</p>
                    </a>
                    
                    <a href="orls_reports_form.html" data-role-card="deputy_head" class="bg-orange-500 hover:bg-orange-600 text-white font-bold p-6 rounded-2xl shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-chart-line text-3xl mb-4"></i>
                        <h3 class="text-xl">Сформировка отчетов</h3>
                        <p class="text-sm opacity-80">Сводная статистика по неактивам и принятым аттестациям.</p>
                    </a>
                    
                    <a href="information_department.html" data-role-card="all" class="bg-teal-500 hover:bg-teal-600 text-white font-bold p-6 rounded-2xl shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-info-circle text-3xl mb-4"></i>
                        <h3 class="text-xl">Информационный отдел</h3>
                        <p class="text-sm opacity-80">Важные объявления и полезная информация для всех.</p>
                    </a>
                </div>

                <!-- Новый раздел для действующих строев -->
                <div class="mt-10 p-6 bg-gray-50 rounded-2xl shadow-inner">
                    <h3 class="text-3xl font-bold text-gray-900 mb-4">Действующие строи</h3>
                    <div id="activeFormations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Здесь будут отображаться строи -->
                    </div>
                    <div class="flex space-x-4 mt-6">
                        <button id="addFormationBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Добавить тестовый строй</button>
                        <button id="clearFormationsBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Очистить все строи</button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script type="module">
        const navItems = document.querySelectorAll('aside nav li');
        const cards = document.querySelectorAll('main a[data-role-card]');
        const activeFormationsContainer = document.getElementById('activeFormations');
        const addFormationBtn = document.getElementById('addFormationBtn');
        const clearFormationsBtn = document.getElementById('clearFormationsBtn');

        // Эту переменную необходимо инициализировать на стороне сервера в зависимости от роли пользователя.
        // Для примера, она жестко задана.
        const userRole = 'deputy_head'; // Возможные значения: 'deputy_head', 'instructor', 'senior_instructor'

        function updateUIForRole(role) {
            const rolesMap = {
                'deputy_head': ['all', 'deputy_head'],
                'instructor': ['all'],
                'senior_instructor': ['all', 'senior_instructor']
            };
            const allowedRoles = rolesMap[role] || [];
            
            navItems.forEach(item => {
                const itemRole = item.dataset.role;
                item.style.display = allowedRoles.includes(itemRole) ? 'block' : 'none';
            });
            cards.forEach(card => {
                const cardRole = card.dataset.roleCard;
                card.style.display = allowedRoles.includes(cardRole) ? 'block' : 'none';
            });
        }
        
        // Listen for changes to the formations collection in real-time
        async function listenForFormations() {
            if (!window.db) {
                console.error("Firebase Firestore is not initialized.");
                return;
            }

            const formationsCollection = window.firestore.collection(window.db, `artifacts/${window.__app_id}/public/data/formations`);
            
            window.firestore.onSnapshot(formationsCollection, (snapshot) => {
                if (snapshot.empty) {
                    activeFormationsContainer.innerHTML = '<p class="text-gray-500">На данный момент действующих строев нет.</p>';
                    return;
                }

                activeFormationsContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const formation = doc.data();
                    const formationCard = document.createElement('div');
                    formationCard.className = 'bg-white p-4 rounded-lg shadow-md';
                    formationCard.innerHTML = `
                        <h4 class="text-xl font-bold mb-2">${formation.name}</h4>
                        <p class="text-sm text-gray-600"><strong>Участники:</strong> ${formation.members}</p>
                        <p class="text-sm text-gray-600"><strong>Руководитель:</strong> ${formation.leader}</p>
                        <p class="text-sm text-gray-600"><strong>Начало:</strong> ${formation.startTime}</p>
                    `;
                    activeFormationsContainer.appendChild(formationCard);
                });
            }, (error) => {
                console.error("Error listening to formations:", error);
            });
        }

        // Add a test formation to the database
        addFormationBtn.addEventListener('click', async () => {
            const formationsCollection = window.firestore.collection(window.db, `artifacts/${window.__app_id}/public/data/formations`);
            const now = new Date();
            const formationData = {
                name: `Тестовый строй #${Math.floor(Math.random() * 100)}`,
                members: Math.floor(Math.random() * 20) + 1,
                leader: "Тестовый руководитель",
                startTime: now.getHours() + ':' + now.getMinutes()
            };
            try {
                await window.firestore.addDoc(formationsCollection, formationData);
                console.log("Formation added successfully.");
            } catch (e) {
                console.error("Error adding formation: ", e);
            }
        });

        // Clear all formations from the database
        clearFormationsBtn.addEventListener('click', async () => {
            if (!confirm("Вы уверены, что хотите удалить все действующие строи?")) return;
            const formationsCollectionRef = window.firestore.collection(window.db, `artifacts/${window.__app_id}/public/data/formations`);
            try {
                const snapshot = await window.firestore.getDocs(formationsCollectionRef);
                const batch = window.firestore.db.runTransaction(async (transaction) => {
                    snapshot.forEach((doc) => {
                        transaction.delete(doc.ref);
                    });
                });
                await batch;
                console.log("All formations cleared.");
            } catch (e) {
                console.error("Error clearing formations: ", e);
            }
        });

        window.onload = () => {
            updateUIForRole(userRole);
            // Wait for Firebase to be initialized before starting the listener
            const checkFirebase = setInterval(() => {
                if (window.db) {
                    clearInterval(checkFirebase);
                    listenForFormations();
                }
            }, 100);
        };
    </script>
    
</body>
</html>
