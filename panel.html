<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ГИБДД ОРЛС</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .sidebar { width: 250px; min-height: 100vh; }
        .main-content { width: calc(100% - 250px); min-height: 100vh; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .question-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .question-item button {
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex">
    <aside class="sidebar bg-gray-800 text-gray-400 p-6 flex flex-col items-center">
        <div class="logo-container mb-8">
            <img src="https://i.ibb.co/6P2M9xP/logo.png" alt="ГИБДД ОРЛС" class="h-20 w-20 rounded-full">
        </div>
        <nav class="w-full">
            <ul class="space-y-4">
                <li><a href="#" class="tab-link block py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" data-tab="main-page-tab"><i class="fas fa-home mr-2"></i>Главная</a></li>
                <li><a href="#" class="tab-link block py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" data-tab="upcoming-events-tab"><i class="fas fa-calendar-alt mr-2"></i>Предстоящие строи</a></li>
                <li><a href="#" class="tab-link block py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" data-tab="manage-staff-tab"><i class="fas fa-users-cog mr-2"></i>Управление сотрудниками</a></li>
                <li><a href="#" class="tab-link block py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" data-tab="certifications-tab"><i class="fas fa-clipboard-check mr-2"></i>Аттестации/Переаттестации</a></li>
                <li><a href="#" class="tab-link block py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" data-tab="reporting-tab"><i class="fas fa-chart-line mr-2"></i>Отчетность</a></li>
                <li><a href="#" class="tab-link block py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" data-tab="info-tab"><i class="fas fa-info-circle mr-2"></i>Информационный раздел</a></li>
                <li><a href="#" class="tab-link block py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" data-tab="tests-tab"><i class="fas fa-question-circle mr-2"></i>Тесты для сдачи</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content p-8">
        <div id="main-page-tab" class="tab-content active">
            <h1 class="text-3xl font-bold mb-6">Главная страница</h1>
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold">Новости от руководства</h2>
                <button onclick="openModal('addNewsModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Добавить новость</button>
            </div>
            <div id="news-list" class="space-y-4">
                </div>
            <div class="mt-8">
                <h2 class="text-2xl font-semibold mb-4">Администрирование</h2>
                <button onclick="resetDatabase()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Полное обнуление базы данных</button>
            </div>
        </div>

        <div id="upcoming-events-tab" class="tab-content">
            <h1 class="text-3xl font-bold mb-6">Предстоящие строи</h1>
            <button onclick="openModal('addEventModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-4"><i class="fas fa-plus mr-2"></i>Создать строй</button>
            <div id="upcoming-events" class="space-y-4">
                </div>
        </div>

        <div id="manage-staff-tab" class="tab-content">
            <h1 class="text-3xl font-bold mb-6">Управление сотрудниками</h1>
            <button onclick="openModal('addEmployeeModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-4"><i class="fas fa-user-plus mr-2"></i>Добавить сотрудника</button>
            <div class="bg-gray-800 rounded-lg p-6 shadow-md overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="text-gray-400">
                            <th class="py-2 px-4 text-left">Ник</th>
                            <th class="py-2 px-4 text-left">Звание</th>
                            <th class="py-2 px-4 text-left">Должность</th>
                            <th class="py-2 px-4 text-left">Выговоры</th>
                            <th class="py-2 px-4 text-left">Роль</th>
                        </tr>
                    </thead>
                    <tbody id="employee-list" class="text-gray-300">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="certifications-tab" class="tab-content">
            <h1 class="text-3xl font-bold mb-6">Аттестации/Переаттестации</h1>
            <div class="flex space-x-4 mb-4">
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" onclick="openModal('addCertificationModal')"><i class="fas fa-plus mr-2"></i>Добавить аттестацию</button>
                <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" onclick="openModal('addRecertificationModal')"><i class="fas fa-sync-alt mr-2"></i>Добавить переаттестацию</button>
            </div>
            <div class="mb-4">
                <input type="text" id="filter-nickname" placeholder="Фильтр по никнейму" class="bg-gray-700 text-white rounded-lg p-2 w-full md:w-1/3">
                <button onclick="filterCertifications()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg ml-2">Поиск</button>
            </div>
            <div id="certifications-list" class="space-y-4">
                </div>
        </div>

        <div id="reporting-tab" class="tab-content">
            <h1 class="text-3xl font-bold mb-6">Отчетность</h1>
            <button onclick="openModal('addReportModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-4"><i class="fas fa-plus mr-2"></i>Подать отчет</button>
            <div id="reports-list" class="space-y-4">
                </div>
        </div>

        <div id="info-tab" class="tab-content">
            <h1 class="text-3xl font-bold mb-6">Информационный раздел</h1>
            <button onclick="openModal('addInfoBlockModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-4"><i class="fas fa-plus mr-2"></i>Добавить блок</button>
            <div id="info-blocks-container" class="space-y-4">
                </div>
        </div>
        
        <div id="tests-tab" class="tab-content">
            <h1 class="text-3xl font-bold mb-6">Тесты для сдачи</h1>
            <button onclick="openModal('addTestModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-4"><i class="fas fa-plus mr-2"></i>Создать тест</button>
            <div id="tests-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
        </div>
    </main>

    <div id="addNewsModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3">
            <h2 class="text-2xl font-bold mb-4">Добавление новости</h2>
            <input id="newsTitle" type="text" placeholder="Заголовок новости" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <textarea id="newsContent" placeholder="Текст новости" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4 h-32"></textarea>
            <select id="newsAuthorRole" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
                <option value="Начальник ОРЛС">Начальник ОРЛС</option>
                <option value="Зам. начальника ОРЛС">Зам. начальника ОРЛС</option>
            </select>
            <div class="flex justify-end space-x-4">
                <button onclick="addNews()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Сохранить</button>
                <button onclick="closeModal('addNewsModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>
    
    <div id="addEventModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3">
            <h2 class="text-2xl font-bold mb-4">Создание строя</h2>
            <input id="eventTitle" type="text" placeholder="Описание строя" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <input id="eventCreator" type="text" placeholder="Ваш никнейм" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <div class="flex justify-end space-x-4">
                <button onclick="addEvent()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Сохранить</button>
                <button onclick="closeModal('addEventModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>

    <div id="addEmployeeModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3">
            <h2 class="text-2xl font-bold mb-4">Добавление сотрудника</h2>
            <input id="employeeNickname" type="text" placeholder="Никнейм" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <input id="employeeRank" type="text" placeholder="Звание" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <input id="employeePosition" type="text" placeholder="Должность" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <input id="employeeRole" type="text" placeholder="Роль" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <div class="flex justify-end space-x-4">
                <button onclick="addEmployee()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Добавить</button>
                <button onclick="closeModal('addEmployeeModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>

    <div id="addCertificationModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3">
            <h2 class="text-2xl font-bold mb-4">Добавление аттестации</h2>
            <input id="certEmployeeNickname" type="text" placeholder="Никнейм сотрудника" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <input id="certAttesterNickname" type="text" placeholder="Никнейм проводящего" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <select id="certAttempt" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
                <option value="1">Первая попытка</option>
                <option value="2">Вторая попытка</option>
            </select>
            <select id="certStatus" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
                <option value="Сдал">Сдал</option>
                <option value="Не сдал">Не сдал</option>
            </select>
            <input id="certEvidenceLink" type="text" placeholder="Ссылка на доказательства" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <div class="flex justify-end space-x-4">
                <button onclick="addCertification()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Сохранить</button>
                <button onclick="closeModal('addCertificationModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>
    
    <div id="addRecertificationModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3">
            <h2 class="text-2xl font-bold mb-4">Добавление переаттестации</h2>
            <input id="recertEmployeeNickname" type="text" placeholder="Никнейм сотрудника" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <input id="recertViolation" type="text" placeholder="Что нарушил" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <input id="recertEvidenceLink" type="text" placeholder="Ссылка на доказательства" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <div class="flex justify-end space-x-4">
                <button onclick="addRecertification()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Сохранить</button>
                <button onclick="closeModal('addRecertificationModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>

    <div id="addReportModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3">
            <h2 class="text-2xl font-bold mb-4">Подача отчета</h2>
            <input id="reportEmployeeNickname" type="text" placeholder="Ваш никнейм" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <select id="reportType" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
                <option value="Неактив">Неактив</option>
                <option value="Отпуск">Отпуск</option>
            </select>
            <div class="flex justify-end space-x-4">
                <button onclick="addReport()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Отправить</button>
                <button onclick="closeModal('addReportModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>
    
    <div id="addInfoBlockModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3">
            <h2 class="text-2xl font-bold mb-4">Добавление информационного блока</h2>
            <input id="infoBlockTitle" type="text" placeholder="Заголовок" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <textarea id="infoBlockContent" placeholder="Текст блока" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4 h-32"></textarea>
            <input id="infoBlockAuthorRole" type="text" placeholder="Ваша роль" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <div class="flex justify-end space-x-4">
                <button onclick="addInfoBlock()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Сохранить</button>
                <button onclick="closeModal('addInfoBlockModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>

    <div id="addTestModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3">
            <h2 class="text-2xl font-bold mb-4">Создание теста</h2>
            <input id="testTitle" type="text" placeholder="Название теста" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <div class="flex justify-end space-x-4">
                <button onclick="addTest()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Сохранить</button>
                <button onclick="closeModal('addTestModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>
    
    <div id="editTestModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-1/3 max-h-screen overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Редактирование теста</h2>
            <input id="editTestTitle" type="text" placeholder="Название теста" class="bg-gray-700 text-white w-full p-2 rounded-lg mb-4">
            <div id="questions-container"></div>
            <button onclick="addQuestionToEditModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mt-4"><i class="fas fa-plus mr-2"></i>Добавить вопрос</button>
            <div class="flex justify-end space-x-4 mt-4">
                <button onclick="saveTestChanges()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Сохранить</button>
                <button onclick="closeModal('editTestModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let currentEditingTestId = null;

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = link.dataset.tab;
                tabContents.forEach(content => content.classList.remove('active'));
                tabLinks.forEach(tabLink => tabLink.classList.remove('bg-gray-700'));
                document.getElementById(tabId).classList.add('active');
                link.classList.add('bg-gray-700');
                
                // Load data based on the active tab
                if (tabId === 'main-page-tab') loadNews();
                if (tabId === 'upcoming-events-tab') loadEvents();
                if (tabId === 'manage-staff-tab') loadEmployees();
                if (tabId === 'certifications-tab') loadCertifications();
                if (tabId === 'reporting-tab') loadReports();
                if (tabId === 'info-tab') loadInfoBlocks();
                if (tabId === 'tests-tab') loadTests();
            });
        });

        // --- Функции для взаимодействия с API ---
        
        // Полное обнуление
        async function resetDatabase() {
            if (confirm('ВНИМАНИЕ: Вы уверены, что хотите полностью очистить базу данных? Это действие необратимо!')) {
                try {
                    const response = await fetch(`${API_URL}/reset`, { method: 'POST' });
                    if (response.ok) {
                        alert('База данных успешно очищена!');
                        window.location.reload();
                    } else {
                        const error = await response.json();
                        alert(`Ошибка: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Ошибка при сбросе базы данных:', error);
                    alert('Ошибка: не удалось подключиться к серверу для сброса данных.');
                }
            }
        }
        
        // Новости
        async function loadNews() {
            try {
                const response = await fetch(`${API_URL}/news`);
                if (!response.ok) throw new Error('Ошибка сети при загрузке новостей.');
                const news = await response.json();
                const container = document.getElementById('news-list');
                container.innerHTML = '';
                news.forEach(item => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'bg-gray-800 p-4 rounded-lg mb-2 shadow-lg';
                    newsItem.innerHTML = `
                        <h3 class="text-xl font-bold text-white mb-2">${item.title}</h3>
                        <p class="text-gray-300">${item.content}</p>
                        <p class="text-gray-500 text-sm mt-4">
                            ${item.authorRole} | ${new Date(item.dateCreated).toLocaleDateString('ru-RU')}
                        </p>
                    `;
                    container.appendChild(newsItem);
                });
            } catch (error) {
                console.error('Ошибка при загрузке новостей:', error);
                alert('Не удалось загрузить новости. Проверьте, запущен ли сервер.');
            }
        }

        async function addNews() {
            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            const authorRole = document.getElementById('newsAuthorRole').value;
            try {
                const response = await fetch(`${API_URL}/news`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content, authorRole })
                });
                if (response.ok) {
                    alert('Новость успешно добавлена!');
                    loadNews();
                    closeModal('addNewsModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка при добавлении новости: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при добавлении новости:', error);
                alert('Ошибка: не удалось подключиться к серверу.');
            }
        }
        
        // Сотрудники
        async function loadEmployees() {
            try {
                const response = await fetch(`${API_URL}/employees`);
                if (!response.ok) throw new Error('Ошибка сети при загрузке сотрудников.');
                const employees = await response.json();
                const tableBody = document.getElementById('employee-list');
                tableBody.innerHTML = '';
                employees.forEach(emp => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-2 px-4 border-b">${emp.nickname}</td>
                        <td class="py-2 px-4 border-b">${emp.rank}</td>
                        <td class="py-2 px-4 border-b">${emp.position || '-'}</td>
                        <td class="py-2 px-4 border-b">${emp.warnings}</td>
                        <td class="py-2 px-4 border-b">${emp.role || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Ошибка при загрузке сотрудников:', error);
                alert('Не удалось загрузить сотрудников. Проверьте, запущен ли сервер.');
            }
        }

        async function addEmployee() {
            const nickname = document.getElementById('employeeNickname').value;
            const rank = document.getElementById('employeeRank').value;
            const position = document.getElementById('employeePosition').value;
            const role = document.getElementById('employeeRole').value;
            try {
                const response = await fetch(`${API_URL}/employees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname, rank, position, role })
                });
                if (response.ok) {
                    alert('Сотрудник успешно добавлен!');
                    loadEmployees();
                    closeModal('addEmployeeModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при добавлении:', error);
                alert('Ошибка: не удалось подключиться к серверу.');
            }
        }

        // Строи
        async function loadEvents() {
            try {
                const response = await fetch(`${API_URL}/events`);
                if (!response.ok) throw new Error('Ошибка сети при загрузке строев.');
                const events = await response.json();
                const container = document.getElementById('upcoming-events');
                container.innerHTML = '';
                events.forEach(event => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-700 p-4 rounded-lg mb-2';
                    item.innerHTML = `
                        <p class="text-white">${event.title}</p>
                        <p class="text-gray-400 text-sm">Создан: ${event.creatorNickname}</p>
                        <p class="text-gray-400 text-sm">Дата: ${new Date(event.date).toLocaleString('ru-RU')}</p>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Ошибка при загрузке строев:', error);
                alert('Не удалось загрузить строи. Проверьте, запущен ли сервер.');
            }
        }

        async function addEvent() {
            const title = document.getElementById('eventTitle').value;
            const creatorNickname = document.getElementById('eventCreator').value;
            try {
                const response = await fetch(`${API_URL}/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, creatorNickname, date: new Date() })
                });
                if (response.ok) {
                    alert('Строй успешно создан!');
                    loadEvents();
                    closeModal('addEventModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при создании строя:', error);
                alert('Ошибка: не удалось подключиться к серверу.');
            }
        }

        // Аттестации
        async function loadCertifications() {
            try {
                const response = await fetch(`${API_URL}/certifications`);
                if (!response.ok) throw new Error('Ошибка сети при загрузке аттестаций.');
                const certifications = await response.json();
                const container = document.getElementById('certifications-list');
                container.innerHTML = '';
                certifications.forEach(cert => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-700 p-4 rounded-lg mb-2';
                    item.innerHTML = `
                        <p class="text-white">${cert.type === 'certification' ? 'Аттестация' : 'Переаттестация'} для ${cert.employeeNickname}</p>
                        <p class="text-gray-400 text-sm">Проводил: ${cert.attesterNickname || '-'}</p>
                        <p class="text-gray-400 text-sm">Дата: ${new Date(cert.date).toLocaleDateString('ru-RU')}</p>
                        <p class="text-gray-400 text-sm">Статус: ${cert.status}</p>
                        <p class="text-gray-400 text-sm">Доказательства: <a href="${cert.evidenceLink}" target="_blank" class="text-blue-400 hover:underline">ссылка</a></p>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Ошибка при загрузке аттестаций:', error);
                alert('Не удалось загрузить аттестации. Проверьте, запущен ли сервер.');
            }
        }

        async function addCertification() {
            const employeeNickname = document.getElementById('certEmployeeNickname').value;
            const attesterNickname = document.getElementById('certAttesterNickname').value;
            const attempt = document.getElementById('certAttempt').value;
            const status = document.getElementById('certStatus').value;
            const evidenceLink = document.getElementById('certEvidenceLink').value;
            try {
                const response = await fetch(`${API_URL}/certifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'certification', employeeNickname, attesterNickname, attempt: parseInt(attempt), status, evidenceLink, date: new Date() })
                });
                if (response.ok) {
                    alert('Аттестация успешно добавлена!');
                    loadCertifications();
                    closeModal('addCertificationModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при добавлении аттестации:', error);
                alert('Ошибка: не удалось подключиться к серверу.');
            }
        }
        
        async function addRecertification() {
            const employeeNickname = document.getElementById('recertEmployeeNickname').value;
            const violation = document.getElementById('recertViolation').value;
            const evidenceLink = document.getElementById('recertEvidenceLink').value;
            try {
                const response = await fetch(`${API_URL}/certifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'recertification', employeeNickname, violation, evidenceLink, status: 'Ожидает', date: new Date() })
                });
                if (response.ok) {
                    alert('Переаттестация успешно добавлена!');
                    loadCertifications();
                    closeModal('addRecertificationModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при добавлении переаттестации:', error);
                alert('Ошибка: не удалось подключиться к серверу.');
            }
        }

        async function filterCertifications() {
            const nickname = document.getElementById('filter-nickname').value;
            try {
                const response = await fetch(`${API_URL}/certifications?nickname=${nickname}`);
                if (!response.ok) throw new Error('Ошибка сети при фильтрации аттестаций.');
                const certifications = await response.json();
                const container = document.getElementById('certifications-list');
                container.innerHTML = '';
                certifications.forEach(cert => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-700 p-4 rounded-lg mb-2';
                    item.innerHTML = `
                        <p class="text-white">${cert.type === 'certification' ? 'Аттестация' : 'Переаттестация'} для ${cert.employeeNickname}</p>
                        <p class="text-gray-400 text-sm">Проводил: ${cert.attesterNickname || '-'}</p>
                        <p class="text-gray-400 text-sm">Дата: ${new Date(cert.date).toLocaleDateString('ru-RU')}</p>
                        <p class="text-gray-400 text-sm">Статус: ${cert.status}</p>
                        <p class="text-gray-400 text-sm">Доказательства: <a href="${cert.evidenceLink}" target="_blank" class="text-blue-400 hover:underline">ссылка</a></p>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Ошибка при фильтрации аттестаций:', error);
                alert('Не удалось отфильтровать аттестации. Проверьте, запущен ли сервер.');
            }
        }

        // Отчеты
        async function loadReports() {
            try {
                const response = await fetch(`${API_URL}/reports`);
                if (!response.ok) throw new Error('Ошибка сети при загрузке отчетов.');
                const reports = await response.json();
                const container = document.getElementById('reports-list');
                container.innerHTML = '';
                reports.forEach(report => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-700 p-4 rounded-lg mb-2';
                    item.innerHTML = `
                        <p class="text-white">Отчет на ${report.reportType} от ${report.employeeNickname}</p>
                        <p class="text-gray-400 text-sm">Статус: ${report.status}</p>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Ошибка при загрузке отчетов:', error);
                alert('Не удалось загрузить отчеты. Проверьте, запущен ли сервер.');
            }
        }

        async function addReport() {
            const employeeNickname = document.getElementById('reportEmployeeNickname').value;
            const reportType = document.getElementById('reportType').value;
            try {
                const response = await fetch(`${API_URL}/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employeeNickname, reportType })
                });
                if (response.ok) {
                    alert('Отчет успешно подан!');
                    loadReports();
                    closeModal('addReportModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при подаче отчета:', error);
                alert('Ошибка: не удалось подключиться к серверу.');
            }
        }

        // Информационные блоки
        async function loadInfoBlocks() {
            try {
                const response = await fetch(`${API_URL}/infoblocks`);
                if (!response.ok) throw new Error('Ошибка сети при загрузке инфо-блоков.');
                const infoBlocks = await response.json();
                const container = document.getElementById('info-blocks-container');
                container.innerHTML = '';
                infoBlocks.forEach(block => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-700 p-4 rounded-lg mb-2';
                    item.innerHTML = `
                        <h3 class="text-xl font-bold text-white">${block.title}</h3>
                        <p class="text-gray-300 mt-2">${block.content}</p>
                        <p class="text-gray-500 text-sm mt-2">Добавил: ${block.authorRole}</p>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Ошибка при загрузке инфо-блоков:', error);
                alert('Не удалось загрузить инфо-блоки. Проверьте, запущен ли сервер.');
            }
        }

        async function addInfoBlock() {
            const title = document.getElementById('infoBlockTitle').value;
            const content = document.getElementById('infoBlockContent').value;
            const authorRole = document.getElementById('infoBlockAuthorRole').value;
            try {
                const response = await fetch(`${API_URL}/infoblocks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content, authorRole })
                });
                if (response.ok) {
                    alert('Информационный блок успешно добавлен!');
                    loadInfoBlocks();
                    closeModal('addInfoBlockModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при добавлении инфо-блока:', error);
                alert('Ошибка: не удалось подключиться к серверу.');
            }
        }
        
        // Тесты
        async function loadTests() {
            try {
                const response = await fetch(`${API_URL}/tests`);
                if (!response.ok) throw new Error('Ошибка сети при загрузке тестов.');
                const tests = await response.json();
                const container = document.getElementById('tests-list');
                container.innerHTML = '';
                tests.forEach(test => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-700 p-4 rounded-lg mb-2 flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold">${test.title}</h3>
                            <p class="text-gray-400">${test.questions.length} вопросов</p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="editTest('${test._id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteTest('${test._id}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Ошибка при загрузке тестов:', error);
                alert('Не удалось загрузить тесты. Проверьте, запущен ли сервер.');
            }
        }

        async function addTest() {
            const title = document.getElementById('testTitle').value;
            try {
                const response = await fetch(`${API_URL}/tests`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, questions: [] })
                });
                if (response.ok) {
                    alert('Тест успешно создан!');
                    loadTests();
                    closeModal('addTestModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при создании теста:', error);
                alert('Ошибка: не удалось подключиться к серверу.');
            }
        }

        async function editTest(testId) {
            currentEditingTestId = testId;
            openModal('editTestModal');
            try {
                const response = await fetch(`${API_URL}/tests/${testId}`);
                if (!response.ok) throw new Error('Ошибка сети при загрузке теста для редактирования.');
                const test = await response.json();
                document.getElementById('editTestTitle').value = test.title;
                const container = document.getElementById('questions-container');
                container.innerHTML = '';
                test.questions.forEach((q) => {
                    addQuestionItem(q, container);
                });
            } catch (error) {
                console.error('Ошибка при загрузке теста для редактирования:', error);
                closeModal('editTestModal');
            }
        }

        function addQuestionItem(question = { text: '', options: ['', '', '', ''], answer: '' }, container = document.getElementById('questions-container')) {
            const item = document.createElement('div');
            item.className = 'question-item bg-gray-700 rounded-lg p-4 mb-4';
            item.innerHTML = `
                <div class="mb-2">
                    <label class="block text-sm font-bold mb-1">Вопрос:</label>
                    <input type="text" value="${question.text}" class="w-full bg-gray-600 text-white p-2 rounded-lg" data-field="text">
                </div>
                <div class="mb-2">
                    <label class="block text-sm font-bold mb-1">Варианты ответов:</label>
                    <input type="text" value="${question.options[0] || ''}" placeholder="Вариант 1" class="w-full bg-gray-600 text-white p-2 rounded-lg mb-1" data-field="option">
                    <input type="text" value="${question.options[1] || ''}" placeholder="Вариант 2" class="w-full bg-gray-600 text-white p-2 rounded-lg mb-1" data-field="option">
                    <input type="text" value="${question.options[2] || ''}" placeholder="Вариант 3" class="w-full bg-gray-600 text-white p-2 rounded-lg mb-1" data-field="option">
                    <input type="text" value="${question.options[3] || ''}" placeholder="Вариант 4" class="w-full bg-gray-600 text-white p-2 rounded-lg" data-field="option">
                </div>
                <div class="mb-2">
                    <label class="block text-sm font-bold mb-1">Правильный ответ:</label>
                    <input type="text" value="${question.answer}" placeholder="Правильный ответ" class="w-full bg-gray-600 text-white p-2 rounded-lg" data-field="answer">
                </div>
                <button onclick="removeQuestionItem(this)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg">Удалить вопрос</button>
            `;
            container.appendChild(item);
        }
        
        function addQuestionToEditModal() {
            addQuestionItem();
        }

        function removeQuestionItem(button) {
            button.parentElement.remove();
        }

        async function saveTestChanges() {
            const title = document.getElementById('editTestTitle').value;
            const questionsContainer = document.getElementById('questions-container');
            const questionItems = questionsContainer.querySelectorAll('.question-item');
            const questions = [];
            questionItems.forEach(item => {
                const text = item.querySelector('[data-field="text"]').value;
                const answer = item.querySelector('[data-field="answer"]').value;
                const options = Array.from(item.querySelectorAll('[data-field="option"]')).map(input => input.value).filter(val => val);
                if (text && answer) {
                    questions.push({ text, options, answer });
                }
            });

            try {
                const response = await fetch(`${API_URL}/tests/${currentEditingTestId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, questions })
                });

                if (response.ok) {
                    alert('Тест успешно обновлен!');
                    loadTests();
                    closeModal('editTestModal');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.message}`);
                }
            } catch (error) {
                console.error('Ошибка при сохранении теста:', error);
            }
        }

        async function deleteTest(testId) {
            if (confirm('Вы уверены, что хотите удалить этот тест?')) {
                try {
                    const response = await fetch(`${API_URL}/tests/${testId}`, { method: 'DELETE' });
                    if (response.ok) {
                        alert('Тест успешно удален!');
                        loadTests();
                    } else {
                        const error = await response.json();
                        alert(`Ошибка: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Ошибка при удалении теста:', error);
                }
            }
        }

        // Загрузка данных при инициализации
        window.onload = function() {
            // Активируем вкладку "Главная" при загрузке страницы
            document.getElementById('main-page-tab').classList.add('active');
            document.querySelector('[data-tab="main-page-tab"]').classList.add('bg-gray-700');
            loadNews();
        };
    </script>
</body>
</html>
