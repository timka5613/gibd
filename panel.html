<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ГИБДД ОРЛС</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .sidebar { width: 250px; min-height: 100vh; }
        .main-content { width: calc(100% - 250px); min-height: 100vh; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { opacity: 0; visibility: hidden; transition: opacity .2s, visibility .2s; }
        .modal.active { opacity: 1; visibility: visible; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body class="flex bg-gray-100">

<!-- Sidebar -->
<div class="sidebar bg-blue-800 text-white flex flex-col" id="sidebar">
    <div class="logo-box p-4 border-b border-blue-700"><h1 class="text-xl font-bold">ГИБДД ОРЛС</h1></div>
    <div class="user-info p-4 flex items-center border-b border-blue-700">
        <div class="bg-blue-600 rounded-full w-10 h-10 flex items-center justify-center mr-3"><span id="userAvatar"></span></div>
        <div>
            <div class="font-medium" id="userName">Загрузка...</div>
            <div class="text-xs text-blue-200" id="userRole">Загрузка...</div>
        </div>
    </div>
    <nav class="flex-1 overflow-y-auto py-2">
        <ul>
            <li><a href="#" onclick="showTab('dashboard')">Главная</a></li>
            <li><a href="#" onclick="showTab('staff')">Штат сотрудников</a></li>
            <li><a href="#" onclick="showTab('certifications')">Аттестации</a></li>
            <li><a href="#" onclick="showTab('parades')">Строи</a></li>
            <li><a href="#" onclick="showTab('reports')">Отчетность</a></li>
            <li><a href="#" onclick="showTab('info')">Информация</a></li>
        </ul>
    </nav>
    <button onclick="logout()" class="p-4 bg-blue-700 hover:bg-blue-600 transition text-center text-sm">Выйти</button>
</div>

<!-- Main Content -->
<div class="main-content bg-gray-100 p-8" id="mainContent">
    <!-- Главная -->
    <div id="dashboard" class="tab-content active">
        <h2 class="text-2xl font-bold mb-6">Главная</h2>
        <div id="paradeList"></div>
    </div>

    <!-- Штат сотрудников -->
    <div id="staff" class="tab-content">
        <h2 class="text-2xl font-bold mb-6">Штат сотрудников</h2>
        <button onclick="openModal('addStaffModal')" class="bg-green-500 text-white py-2 px-4 rounded-lg mb-4">Добавить сотрудника</button>
        <input type="text" id="staffFilter" placeholder="Фильтр по нику..." class="mb-4 p-2 border rounded w-full" oninput="renderStaffTable()">
        <table class="w-full text-left table-auto">
            <thead>
                <tr>
                    <th>Аватар</th><th>Ник</th><th>Звание</th><th>Погоны</th><th>Выговоры</th><th>Должность</th><th>Личное дело</th><th>Отчетность</th><th>Действия</th>
                </tr>
            </thead>
            <tbody id="staffTable"></tbody>
        </table>
    </div>

    <!-- Аттестации -->
    <div id="certifications" class="tab-content">
        <h2 class="text-2xl font-bold mb-6">Аттестации и переаттестации</h2>
        <div class="mb-4 flex gap-4">
            <button onclick="showCertTab('attest')" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Аттестации</button>
            <button onclick="showCertTab('retest')" class="bg-purple-500 text-white py-2 px-4 rounded-lg">Переаттестации</button>
        </div>
        <input type="text" id="certFilter" placeholder="Фильтр по нику..." class="mb-2 p-2 border rounded w-full" oninput="renderCertTables()">
        <div id="certAttest"></div>
        <div id="certRetest" style="display:none"></div>
    </div>

    <!-- Строи -->
    <div id="parades" class="tab-content">
        <h2 class="text-2xl font-bold mb-6">Строи</h2>
        <button onclick="openModal('addParadeModal')" class="bg-blue-500 text-white py-2 px-4 rounded-lg mb-4">Запланировать строй</button>
        <ul id="paradesTable"></ul>
    </div>

    <!-- Отчетность -->
    <div id="reports" class="tab-content">
        <h2 class="text-2xl font-bold mb-6">Отчетность</h2>
        <button onclick="openModal('addReportModal')" class="bg-blue-500 text-white py-2 px-4 rounded-lg mb-4">Подать отчет</button>
        <button onclick="openModal('addInactiveModal')" class="bg-yellow-500 text-white py-2 px-4 rounded-lg mb-4">Оставить неактив</button>
        <div id="myReports"></div>
        <div id="myInactives"></div>
        <div id="allReports"></div>
        <div id="allInactives"></div>
    </div>

    <!-- Информация -->
    <div id="info" class="tab-content">
        <h2 class="text-2xl font-bold mb-6">Информация об отделе</h2>
        <button onclick="openModal('addInfoModal')" class="bg-blue-500 text-white py-2 px-4 rounded-lg mb-4">Добавить блок</button>
        <div id="infoBlocks"></div>
    </div>
</div>

<!-- Модальные окна (пример для добавления сотрудника) -->
<div id="addStaffModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Добавить сотрудника</h3>
        <form id="staffForm">
            <input type="text" name="nickname" placeholder="Ник" class="mb-2 p-2 border rounded w-full" required>
            <select name="role" class="mb-2 p-2 border rounded w-full" required></select>
            <input type="text" name="rank" placeholder="Звание" class="mb-2 p-2 border rounded w-full" required>
            <input type="text" name="avatar" placeholder="Ссылка на аватар" class="mb-2 p-2 border rounded w-full">
            <input type="text" name="epaulet" placeholder="Погоны (ссылка на картинку)" class="mb-2 p-2 border rounded w-full">
            <input type="number" name="warnings" placeholder="Выговоры" class="mb-2 p-2 border rounded w-full" min="0">
            <input type="text" name="position" placeholder="Должность" class="mb-2 p-2 border rounded w-full" required>
            <input type="text" name="personalFile" placeholder="Личное дело" class="mb-2 p-2 border rounded w-full">
            <input type="text" name="report" placeholder="Отчетность" class="mb-2 p-2 border rounded w-full">
            <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('addStaffModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

      <!-- ... остальные модальные окна ... -->

<!-- Модальное окно добавления аттестации -->
<div id="addAttestModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Добавить аттестацию</h3>
        <form id="attestForm">
            <input type="text" name="nickname" placeholder="Ник сотрудника" class="mb-2 p-2 border rounded w-full" required>
            <input type="text" name="acceptedBy" placeholder="Кто принял аттестацию" class="mb-2 p-2 border rounded w-full" required>
            <input type="date" name="date" placeholder="Дата принятия" class="mb-2 p-2 border rounded w-full" required>
            <select name="attempt" class="mb-2 p-2 border rounded w-full">
                <option value="1">Первая попытка</option>
                <option value="2">Вторая попытка</option>
            </select>
            <select name="result" class="mb-2 p-2 border rounded w-full">
                <option value="Сдал">Сдал</option>
                <option value="Не сдал">Не сдал</option>
            </select>
            <input type="url" name="proof" placeholder="Ссылка на доказательство" class="mb-2 p-2 border rounded w-full">
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('addAttestModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно добавления переаттестации -->
<div id="addRetestModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Добавить переаттестацию</h3>
        <form id="retestForm">
            <input type="text" name="nickname" placeholder="Ник сотрудника" class="mb-2 p-2 border rounded w-full" required>
            <input type="date" name="date" placeholder="Дата переаттестации" class="mb-2 p-2 border rounded w-full" required>
            <input type="text" name="violation" placeholder="Что нарушил" class="mb-2 p-2 border rounded w-full">
            <input type="url" name="proof" placeholder="Ссылка на доказательство" class="mb-2 p-2 border rounded w-full">
            <select name="attempt" class="mb-2 p-2 border rounded w-full">
                <option value="1">Первая попытка</option>
                <option value="2">Вторая попытка</option>
            </select>
            <input type="text" name="acceptedBy" placeholder="Кто принял переаттестацию" class="mb-2 p-2 border rounded w-full">
            <select name="final" class="mb-2 p-2 border rounded w-full">
                <option value="Ожидает">Ожидает</option>
                <option value="Уволен">Уволен</option>
                <option value="Сдал">Сдал</option>
                <option value="По собственному желанию">По собственному желанию</option>
            </select>
            <button type="submit" class="bg-purple-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('addRetestModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно добавления блока информации -->
<div id="addInfoModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Добавить информационный блок</h3>
        <form id="infoForm">
            <input type="text" name="title" placeholder="Заголовок" class="mb-2 p-2 border rounded w-full" required>
            <textarea name="content" placeholder="Текст блока" class="mb-2 p-2 border rounded w-full h-32" required></textarea>
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('addInfoModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно добавления отчета -->
<div id="addReportModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Подать отчет</h3>
        <form id="reportForm">
            <input type="text" name="subject" placeholder="Тема отчета" class="mb-2 p-2 border rounded w-full" required>
            <textarea name="text" placeholder="Текст отчета" class="mb-2 p-2 border rounded w-full h-32" required></textarea>
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Отправить</button>
            <button type="button" onclick="closeModal('addReportModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно добавления неактива -->
<div id="addInactiveModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Оставить неактив</h3>
        <form id="inactiveForm">
            <input type="date" name="start" placeholder="Дата начала" class="mb-2 p-2 border rounded w-full" required>
            <input type="date" name="end" placeholder="Дата окончания" class="mb-2 p-2 border rounded w-full" required>
            <textarea name="reason" placeholder="Причина" class="mb-2 p-2 border rounded w-full h-24" required></textarea>
            <button type="submit" class="bg-yellow-500 text-white py-2 px-4 rounded-lg">Отправить</button>
            <button type="button" onclick="closeModal('addInactiveModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

      <!-- Модальное окно редактирования сотрудника -->
<div id="editStaffModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Редактировать сотрудника</h3>
        <form id="editStaffForm">
            <input type="hidden" name="id">
            <input type="text" name="nickname" placeholder="Ник" class="mb-2 p-2 border rounded w-full" required>
            <select name="role" class="mb-2 p-2 border rounded w-full" required></select>
            <input type="text" name="rank" placeholder="Звание" class="mb-2 p-2 border rounded w-full" required>
            <input type="text" name="avatar" placeholder="Ссылка на аватар" class="mb-2 p-2 border rounded w-full">
            <input type="text" name="epaulet" placeholder="Погоны (ссылка на картинку)" class="mb-2 p-2 border rounded w-full">
            <input type="number" name="warnings" placeholder="Выговоры" class="mb-2 p-2 border rounded w-full" min="0">
            <input type="text" name="position" placeholder="Должность" class="mb-2 p-2 border rounded w-full" required>
            <input type="text" name="personalFile" placeholder="Личное дело" class="mb-2 p-2 border rounded w-full">
            <input type="text" name="report" placeholder="Отчетность" class="mb-2 p-2 border rounded w-full">
            <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('editStaffModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно редактирования аттестации -->
<div id="editAttestModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Редактировать аттестацию</h3>
        <form id="editAttestForm">
            <input type="hidden" name="id">
            <input type="text" name="nickname" placeholder="Ник сотрудника" class="mb-2 p-2 border rounded w-full" required>
            <input type="text" name="acceptedBy" placeholder="Кто принял аттестацию" class="mb-2 p-2 border rounded w-full" required>
            <input type="date" name="date" class="mb-2 p-2 border rounded w-full" required>
            <select name="attempt" class="mb-2 p-2 border rounded w-full">
                <option value="1">Первая попытка</option>
                <option value="2">Вторая попытка</option>
            </select>
            <select name="result" class="mb-2 p-2 border rounded w-full">
                <option value="Сдал">Сдал</option>
                <option value="Не сдал">Не сдал</option>
            </select>
            <input type="url" name="proof" placeholder="Ссылка на доказательство" class="mb-2 p-2 border rounded w-full">
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('editAttestModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно редактирования переаттестации -->
<div id="editRetestModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Редактировать переаттестацию</h3>
        <form id="editRetestForm">
            <input type="hidden" name="id">
            <input type="text" name="nickname" placeholder="Ник сотрудника" class="mb-2 p-2 border rounded w-full" required>
            <input type="date" name="date" class="mb-2 p-2 border rounded w-full" required>
            <input type="text" name="violation" placeholder="Что нарушил" class="mb-2 p-2 border rounded w-full">
            <input type="url" name="proof" placeholder="Ссылка на доказательство" class="mb-2 p-2 border rounded w-full">
            <select name="attempt" class="mb-2 p-2 border rounded w-full">
                <option value="1">Первая попытка</option>
                <option value="2">Вторая попытка</option>
            </select>
            <input type="text" name="acceptedBy" placeholder="Кто принял переаттестацию" class="mb-2 p-2 border rounded w-full">
            <select name="final" class="mb-2 p-2 border rounded w-full">
                <option value="Ожидает">Ожидает</option>
                <option value="Уволен">Уволен</option>
                <option value="Сдал">Сдал</option>
                <option value="По собственному желанию">По собственному желанию</option>
            </select>
            <button type="submit" class="bg-purple-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('editRetestModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно редактирования блока информации -->
<div id="editInfoModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Редактировать информационный блок</h3>
        <form id="editInfoForm">
            <input type="hidden" name="id">
            <input type="text" name="title" placeholder="Заголовок" class="mb-2 p-2 border rounded w-full" required>
            <textarea name="content" placeholder="Текст блока" class="mb-2 p-2 border rounded w-full h-32" required></textarea>
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('editInfoModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
      <!-- Модальное окно редактирования отчета -->
<div id="editReportModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Редактировать отчет</h3>
        <form id="editReportForm">
            <input type="hidden" name="id">
            <input type="text" name="subject" placeholder="Тема отчета" class="mb-2 p-2 border rounded w-full" required>
            <textarea name="text" placeholder="Текст отчета" class="mb-2 p-2 border rounded w-full h-32" required></textarea>
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('editReportModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно редактирования неактива -->
<div id="editInactiveModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Редактировать неактив</h3>
        <form id="editInactiveForm">
            <input type="hidden" name="id">
            <input type="date" name="start" placeholder="Дата начала" class="mb-2 p-2 border rounded w-full" required>
            <input type="date" name="end" placeholder="Дата окончания" class="mb-2 p-2 border rounded w-full" required>
            <textarea name="reason" placeholder="Причина" class="mb-2 p-2 border rounded w-full h-24" required></textarea>
            <button type="submit" class="bg-yellow-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('editInactiveModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно редактирования строя -->
<div id="editParadeModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-lg font-bold mb-4">Редактировать строй</h3>
        <form id="editParadeForm">
            <input type="hidden" name="id">
            <input type="text" name="department" placeholder="Подразделение" class="mb-2 p-2 border rounded w-full" required>
            <input type="time" name="paradeTime" placeholder="Время" class="mb-2 p-2 border rounded w-full" required>
            <textarea name="paradeText" placeholder="Текст уведомления" class="mb-2 p-2 border rounded w-full h-24" required></textarea>
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Сохранить</button>
            <button type="button" onclick="closeModal('editParadeModal')" class="bg-gray-500 text-white py-2 px-4 rounded-lg ml-2">Отмена</button>
        </form>
    </div>
</div>
      
<script>
// --- Константы ролей ---
const ROLES = [
    'Начальник ОРЛС',
    'ГУ ГИБДД',
    'Зам Начальника ОРЛС',
    'Старший Инструктор ОРЛС',
    'Инструктор ОРЛС',
    'Стажер ОРЛС'
];

// --- Выпадающий список ролей для модальных окон ---
function populateRoleSelects() {
    document.querySelectorAll('select[name="role"]').forEach(select => {
        select.innerHTML = '';
        ROLES.forEach(role => {
            const option = document.createElement('option');
            option.value = role;
            option.textContent = role;
            select.appendChild(option);
        });
    });
}

// --- Вызов при загрузке страницы ---
window.onload = function() {
    populateRoleSelects();
    // ...другие функции и инициализация...
};

// ...existing code...
// ...existing code...

// --- Инициализация базы данных ---
let db = JSON.parse(localStorage.getItem('panelDB') || '{}');
if (!db.staff) db.staff = [];
if (!db.parades) db.parades = [];
if (!db.reports) db.reports = [];
if (!db.inactives) db.inactives = [];
if (!db.info) db.info = [];
if (!db.certAttest) db.certAttest = [];
if (!db.certRetest) db.certRetest = [];
if (!db.user) db.user = {nickname: "Timofey_Tenkov", role: "Начальник ОРЛС", avatar: ""};
function saveDB() { localStorage.setItem('panelDB', JSON.stringify(db)); }

// --- Очистка строев в 00:00 по Москве ---
setInterval(() => {
    const now = new Date();
    if (now.getHours() === 0 && now.getMinutes() === 0) {
        db.parades = [];
        saveDB();
        renderParades();
        renderDashboard();
    }
}, 60000);

// --- Фильтрация по нику для сотрудников и аттестаций ---
function renderStaffTable() {
    const filter = document.getElementById('staffFilter').value.toLowerCase();
    const tbody = document.getElementById('staffTable');
    tbody.innerHTML = '';
    db.staff.filter(s => s.nickname.toLowerCase().includes(filter)).forEach(s => {
        tbody.innerHTML += `
            <tr>
                <td><img src="${s.avatar||''}" class="avatar"></td>
                <td>${s.nickname}</td>
                <td>${s.rank}</td>
                <td><img src="${s.epaulet||''}" style="height:24px"></td>
                <td>${s.warnings||0}</td>
                <td>${s.position}</td>
                <td>${s.personalFile||''}</td>
                <td>${s.report||''}</td>
                <td>
                    <button onclick="editStaff('${s.id}')" class="bg-blue-500 text-white px-2 py-1 rounded">Редактировать</button>
                </td>
            </tr>
        `;
    });
}

// --- Фильтрация по нику для аттестаций и переаттестаций ---
function renderCertTables() {
    const filter = document.getElementById('certFilter').value.toLowerCase();
    // Аттестации
    document.getElementById('certAttest').innerHTML = db.certAttest
        .filter(a => a.nickname.toLowerCase().includes(filter))
        .map(a => `
            <div class="mb-2 p-2 border rounded flex justify-between items-center">
                <div>
                    <b>${a.nickname}</b> (${a.acceptedBy}) — ${a.date} — ${a.attempt} попытка — <span class="${a.result==='Сдал'?'text-green-600':'text-red-600'}">${a.result}</span>
                    <a href="${a.proof}" target="_blank" class="text-blue-600 underline ml-2">Доказательство</a>
                </div>
                ${canEditAttest(a) ? `<button onclick="editAttest('${a.id}')" class="bg-blue-500 text-white px-2 py-1 rounded">Редактировать</button>` : ''}
            </div>
        `).join('');
    // Переаттестации
    document.getElementById('certRetest').innerHTML = db.certRetest
        .filter(r => r.nickname.toLowerCase().includes(filter))
        .map(r => `
            <div class="mb-2 p-2 border rounded flex justify-between items-center">
                <div>
                    <b>${r.nickname}</b> — ${r.date} — Нарушил: ${r.violation||'-'} — ${r.attempt} попытка — Итог: <span class="font-bold">${r.final}</span>
                    <a href="${r.proof}" target="_blank" class="text-blue-600 underline ml-2">Доказательство</a>
                </div>
                ${canEditRetest(r) ? `<button onclick="editRetest('${r.id}')" class="bg-purple-500 text-white px-2 py-1 rounded">Редактировать</button>` : ''}
            </div>
        `).join('');
}

// --- Права на редактирование аттестаций ---
function canEditAttest(a) {
    return a.createdBy === db.user.nickname;
}
function canEditRetest(r) {
    return r.createdBy === db.user.nickname || ['Начальник ОРЛС','ГУ ГИБДД'].includes(db.user.role);
}

// --- Добавление сотрудника ---
document.getElementById('staffForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    const staff = {
        id: Date.now().toString(),
        nickname: f.nickname.value,
        role: f.role.value,
        rank: f.rank.value,
        avatar: f.avatar.value,
        epaulet: f.epaulet.value,
        warnings: parseInt(f.warnings.value)||0,
        position: f.position.value,
        personalFile: f.personalFile.value,
        report: f.report.value
    };
    db.staff.push(staff);
    saveDB();
    renderStaffTable();
    closeModal('addStaffModal');
    f.reset();
};

// --- Редактирование сотрудника ---
function editStaff(id) {
    const s = db.staff.find(st => st.id === id);
    if (!s) return;
    const f = document.getElementById('editStaffForm');
    f.id.value = s.id;
    f.nickname.value = s.nickname;
    f.role.value = s.role;
    f.rank.value = s.rank;
    f.avatar.value = s.avatar;
    f.epaulet.value = s.epaulet;
    f.warnings.value = s.warnings;
    f.position.value = s.position;
    f.personalFile.value = s.personalFile;
    f.report.value = s.report;
    openModal('editStaffModal');
}
document.getElementById('editStaffForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    const s = db.staff.find(st => st.id === f.id.value);
    if (s) {
        s.nickname = f.nickname.value;
        s.role = f.role.value;
        s.rank = f.rank.value;
        s.avatar = f.avatar.value;
        s.epaulet = f.epaulet.value;
        s.warnings = parseInt(f.warnings.value)||0;
        s.position = f.position.value;
        s.personalFile = f.personalFile.value;
        s.report = f.report.value;
        saveDB();
        renderStaffTable();
        closeModal('editStaffModal');
    }
};

// --- Добавление аттестации ---
document.getElementById('attestForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    db.certAttest.push({
        id: Date.now().toString(),
        nickname: f.nickname.value,
        acceptedBy: f.acceptedBy.value,
        date: f.date.value,
        attempt: f.attempt.value,
        result: f.result.value,
        proof: f.proof.value,
        createdBy: db.user.nickname
    });
    saveDB();
    renderCertTables();
    closeModal('addAttestModal');
    f.reset();
};

// --- Редактирование аттестации ---
function editAttest(id) {
    const a = db.certAttest.find(at => at.id === id);
    if (!a) return;
    const f = document.getElementById('editAttestForm');
    f.id.value = a.id;
    f.nickname.value = a.nickname;
    f.acceptedBy.value = a.acceptedBy;
    f.date.value = a.date;
    f.attempt.value = a.attempt;
    f.result.value = a.result;
    f.proof.value = a.proof;
    openModal('editAttestModal');
}
document.getElementById('editAttestForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    const a = db.certAttest.find(at => at.id === f.id.value);
    if (a && canEditAttest(a)) {
        a.nickname = f.nickname.value;
        a.acceptedBy = f.acceptedBy.value;
        a.date = f.date.value;
        a.attempt = f.attempt.value;
        a.result = f.result.value;
        a.proof = f.proof.value;
        saveDB();
        renderCertTables();
        closeModal('editAttestModal');
    }
};

// --- Добавление переаттестации ---
document.getElementById('retestForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    db.certRetest.push({
        id: Date.now().toString(),
        nickname: f.nickname.value,
        date: f.date.value,
        violation: f.violation.value,
        proof: f.proof.value,
        attempt: f.attempt.value,
        acceptedBy: f.acceptedBy.value,
        final: f.final.value,
        createdBy: db.user.nickname
    });
    saveDB();
    renderCertTables();
    closeModal('addRetestModal');
    f.reset();
};

// --- Редактирование переаттестации ---
function editRetest(id) {
    const r = db.certRetest.find(rt => rt.id === id);
    if (!r) return;
    const f = document.getElementById('editRetestForm');
    f.id.value = r.id;
    f.nickname.value = r.nickname;
    f.date.value = r.date;
    f.violation.value = r.violation;
    f.proof.value = r.proof;
    f.attempt.value = r.attempt;
    f.acceptedBy.value = r.acceptedBy;
    f.final.value = r.final;
    openModal('editRetestModal');
}
document.getElementById('editRetestForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    const r = db.certRetest.find(rt => rt.id === f.id.value);
    if (r && canEditRetest(r)) {
        r.nickname = f.nickname.value;
        r.date = f.date.value;
        r.violation = f.violation.value;
        r.proof = f.proof.value;
        r.attempt = f.attempt.value;
        r.acceptedBy = f.acceptedBy.value;
        r.final = f.final.value;
        saveDB();
        renderCertTables();
        closeModal('editRetestModal');
    }
};

// --- Добавление блока информации ---
document.getElementById('infoForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    db.info.push({
        id: Date.now().toString(),
        title: f.title.value,
        content: f.content.value,
        createdBy: db.user.nickname
    });
    saveDB();
    renderInfo();
    closeModal('addInfoModal');
    f.reset();
};

// --- Редактирование блока информации ---
function editInfo(id) {
    const info = db.info.find(i => i.id === id);
    if (!info) return;
    const f = document.getElementById('editInfoForm');
    f.id.value = info.id;
    f.title.value = info.title;
    f.content.value = info.content;
    openModal('editInfoModal');
}
document.getElementById('editInfoForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    const info = db.info.find(i => i.id === f.id.value);
    if (info && (db.user.role === 'Начальник ОРЛС' || db.user.role === 'Зам Начальника ОРЛС')) {
        info.title = f.title.value;
        info.content = f.content.value;
        saveDB();
        renderInfo();
        closeModal('editInfoModal');
    }
};

// --- Добавление отчета ---
document.getElementById('reportForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    db.reports.push({
        id: Date.now().toString(),
        nickname: db.user.nickname,
        subject: f.subject.value,
        text: f.text.value,
        createdBy: db.user.nickname
    });
    saveDB();
    renderReports();
    closeModal('addReportModal');
    f.reset();
};

// --- Редактирование отчета ---
function editReport(id) {
    const r = db.reports.find(rep => rep.id === id);
    if (!r) return;
    const f = document.getElementById('editReportForm');
    f.id.value = r.id;
    f.subject.value = r.subject;
    f.text.value = r.text;
    openModal('editReportModal');
}
document.getElementById('editReportForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    const r = db.reports.find(rep => rep.id === f.id.value);
    if (r && r.createdBy === db.user.nickname) {
        r.subject = f.subject.value;
        r.text = f.text.value;
        saveDB();
        renderReports();
        closeModal('editReportModal');
    }
};

// --- Добавление неактива ---
document.getElementById('inactiveForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    db.inactives.push({
        id: Date.now().toString(),
        nickname: db.user.nickname,
        start: f.start.value,
        end: f.end.value,
        reason: f.reason.value,
        createdBy: db.user.nickname
    });
    saveDB();
    renderReports();
    closeModal('addInactiveModal');
    f.reset();
};

// --- Редактирование неактива ---
function editInactive(id) {
    const n = db.inactives.find(ina => ina.id === id);
    if (!n) return;
    const f = document.getElementById('editInactiveForm');
    f.id.value = n.id;
    f.start.value = n.start;
    f.end.value = n.end;
    f.reason.value = n.reason;
    openModal('editInactiveModal');
}
document.getElementById('editInactiveForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    const n = db.inactives.find(ina => ina.id === f.id.value);
    if (n && n.createdBy === db.user.nickname) {
        n.start = f.start.value;
        n.end = f.end.value;
        n.reason = f.reason.value;
        saveDB();
        renderReports();
        closeModal('editInactiveModal');
    }
};

// --- Добавление строя ---
document.getElementById('addParadeForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    db.parades.push({
        id: Date.now().toString(),
        department: f.department.value,
        paradeTime: f.paradeTime.value,
        paradeText: f.paradeText.value,
        createdBy: db.user.nickname
    });
    saveDB();
    renderParades();
    renderDashboard();
    closeModal('addParadeModal');
    f.reset();
};

// --- Редактирование строя ---
function editParade(id) {
    const p = db.parades.find(pa => pa.id === id);
    if (!p) return;
    const f = document.getElementById('editParadeForm');
    f.id.value = p.id;
    f.department.value = p.department;
    f.paradeTime.value = p.paradeTime;
    f.paradeText.value = p.paradeText;
    openModal('editParadeModal');
}
document.getElementById('editParadeForm').onsubmit = function(e) {
    e.preventDefault();
    const f = e.target;
    const p = db.parades.find(pa => pa.id === f.id.value);
    if (p && p.createdBy === db.user.nickname) {
        p.department = f.department.value;
        p.paradeTime = f.paradeTime.value;
        p.paradeText = f.paradeText.value;
        saveDB();
        renderParades();
        renderDashboard();
        closeModal('editParadeModal');
    }
};

// --- Отображение информации ---
function renderInfo() {
    const blocks = db.info.map(i => `
        <div class="mb-4 p-4 border rounded">
            <h4 class="font-bold">${i.title}</h4>
            <div>${i.content}</div>
            ${(db.user.role === 'Начальник ОРЛС' || db.user.role === 'Зам Начальника ОРЛС') && i.createdBy === db.user.nickname
                ? `<button onclick="editInfo('${i.id}')" class="bg-blue-500 text-white px-2 py-1 rounded mt-2">Редактировать</button>`
                : ''}
        </div>
    `).join('');
    document.getElementById('infoBlocks').innerHTML = blocks;
}

// --- Отображение строев ---
function renderParades() {
    document.getElementById('paradesTable').innerHTML = db.parades.map(p => `
        <li class="mb-2 p-2 border rounded flex justify-between items-center">
            <div>
                <b>${p.department}</b> — ${p.paradeTime}<br>${p.paradeText}
            </div>
            ${p.createdBy === db.user.nickname ? `<button onclick="editParade('${p.id}')" class="bg-blue-500 text-white px-2 py-1 rounded">Редактировать</button>` : ''}
        </li>
    `).join('');
    // Главная страница
    document.getElementById('paradeList').innerHTML = db.parades.length
        ? db.parades.map(p => `<div class="mb-2 p-2 border rounded"><b>${p.department}</b> — ${p.paradeTime}<br>${p.paradeText}</div>`).join('')
        : '<div class="text-gray-500">Нет предстоящих строев.</div>';
}

// --- Отображение отчетов и неактивов ---
function renderReports() {
    // Мои отчеты
    document.getElementById('myReports').innerHTML = db.reports.filter(r => r.nickname === db.user.nickname)
        .map(r => `<div class="mb-2 p-2 border rounded flex justify-between items-center">
            <div><b>${r.subject}</b><br>${r.text}</div>
            <button onclick="editReport('${r.id}')" class="bg-blue-500 text-white px-2 py-1 rounded">Редактировать</button>
        </div>`).join('') || '<div class="text-gray-500">Нет отчетов.</div>';
    // Мои неактивы
    document.getElementById('myInactives').innerHTML = db.inactives.filter(n => n.nickname === db.user.nickname)
        .map(n => `<div class="mb-2 p-2 border rounded flex justify-between items-center">
            <div>${n.start} — ${n.end}<br>${n.reason}</div>
            <button onclick="editInactive('${n.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">Редактировать</button>
        </div>`).join('') || '<div class="text-gray-500">Нет неактивов.</div>';
    // Все отчеты (для руководства)
    document.getElementById('allReports').innerHTML = ['Начальник ОРЛС','ГУ ГИБДД','Зам Начальника ОРЛС'].includes(db.user.role)
        ? db.reports.map(r => `<div class="mb-2 p-2 border rounded"><b>${r.nickname}</b>: ${r.subject}<br>${r.text}</div>`).join('')
        : '';
    // Все неактивы (для руководства)
    document.getElementById('allInactives').innerHTML = ['Начальник ОРЛС','ГУ ГИБДД','Зам Начальника ОРЛС'].includes(db.user.role)
        ? db.inactives.map(n => `<div class="mb-2 p-2 border rounded"><b>${n.nickname}</b>: ${n.start} — ${n.end}<br>${n.reason}</div>`).join('')
        : '';
}

// --- Переключение разделов аттестаций ---
function showCertTab(tab) {
    document.getElementById('certAttest').style.display = tab === 'attest' ? '' : 'none';
    document.getElementById('certRetest').style.display = tab === 'retest' ? '' : 'none';
    renderCertTables();
}

// --- Переключение вкладок ---
function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    if (tab === 'staff') renderStaffTable();
    if (tab === 'certifications') renderCertTables();
    if (tab === 'parades') renderParades();
    if (tab === 'reports') renderReports();
    if (tab === 'info') renderInfo();
    if (tab === 'dashboard') renderParades();
}

// --- Модальные окна ---
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// --- Выход из системы ---
function logout() {
    localStorage.removeItem('panelDB');
    location.reload();
}

// --- Инициализация ---
window.onload = function() {
    populateRoleSelects();
    renderStaffTable();
    renderCertTables();
    renderParades();
    renderReports();
    renderInfo();
    showCertTab('attest');
    showTab('dashboard');
};

// ...existing code...

// --- Удаление примеров результатов аттестаций при первой загрузке ---
if (!localStorage.getItem('panelDB')) {
    db.certAttest = [];
    db.certRetest = [];
    saveDB();
}

// --- Аватар пользователя в сайдбаре ---
function renderUserSidebar() {
    document.getElementById('userName').textContent = db.user.nickname;
    document.getElementById('userRole').textContent = db.user.role;
    document.getElementById('userAvatar').innerHTML = db.user.avatar
        ? `<img src="${db.user.avatar}" class="avatar">`
        : `<span class="fas fa-user"></span>`;
}
renderUserSidebar();

// --- Динамическое обновление при изменении данных пользователя ---
function updateUser(nickname, role, avatar) {
    db.user.nickname = nickname;
    db.user.role = role;
    db.user.avatar = avatar;
    saveDB();
    renderUserSidebar();
}

// --- Удаление сотрудника (только для руководства) ---
function deleteStaff(id) {
    if (!['Начальник ОРЛС','ГУ ГИБДД','Зам Начальника ОРЛС'].includes(db.user.role)) return;
    if (confirm('Удалить сотрудника?')) {
        db.staff = db.staff.filter(st => st.id !== id);
        saveDB();
        renderStaffTable();
    }
}

// --- Кнопка удаления сотрудника в таблице (только для руководства) ---
function staffRowActions(staff) {
    let actions = `<button onclick="editStaff('${staff.id}')" class="bg-blue-500 text-white px-2 py-1 rounded">Редактировать</button>`;
    if (['Начальник ОРЛС','ГУ ГИБДД','Зам Начальника ОРЛС'].includes(db.user.role)) {
        actions += `<button onclick="deleteStaff('${staff.id}')" class="bg-red-500 text-white px-2 py-1 rounded ml-2">Удалить</button>`;
    }
    return actions;
}

// --- Перерисовка таблицы сотрудников с действиями ---
function renderStaffTable() {
    const filter = document.getElementById('staffFilter').value.toLowerCase();
    const tbody = document.getElementById('staffTable');
    tbody.innerHTML = '';
    db.staff.filter(s => s.nickname.toLowerCase().includes(filter)).forEach(s => {
        tbody.innerHTML += `
            <tr>
                <td><img src="${s.avatar||''}" class="avatar"></td>
                <td>${s.nickname}</td>
                <td>${s.rank}</td>
                <td><img src="${s.epaulet||''}" style="height:24px"></td>
                <td>${s.warnings||0}</td>
                <td>${s.position}</td>
                <td>${s.personalFile||''}</td>
                <td>${s.report||''}</td>
                <td>${staffRowActions(s)}</td>
            </tr>
        `;
    });
}

// --- Фильтрация и права для информационного раздела ---
function renderInfo() {
    const blocks = db.info.map(i => `
        <div class="mb-4 p-4 border rounded">
            <h4 class="font-bold">${i.title}</h4>
            <div>${i.content}</div>
            ${(db.user.role === 'Начальник ОРЛС' || db.user.role === 'Зам Начальника ОРЛС') && i.createdBy === db.user.nickname
                ? `<button onclick="editInfo('${i.id}')" class="bg-blue-500 text-white px-2 py-1 rounded mt-2">Редактировать</button>`
                : ''}
        </div>
    `).join('');
    document.getElementById('infoBlocks').innerHTML = blocks;
}

// --- Переключение между разделами аттестаций ---
function showCertTab(tab) {
    document.getElementById('certAttest').style.display = tab === 'attest' ? '' : 'none';
    document.getElementById('certRetest').style.display = tab === 'retest' ? '' : 'none';
    renderCertTables();
}

// --- Переключение вкладок ---
function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    if (tab === 'staff') renderStaffTable();
    if (tab === 'certifications') renderCertTables();
    if (tab === 'parades') renderParades();
    if (tab === 'reports') renderReports();
    if (tab === 'info') renderInfo();
    if (tab === 'dashboard') renderParades();
}

// --- Модальные окна ---
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// --- Инициализация ---
window.onload = function() {
    populateRoleSelects();
    renderUserSidebar();
    renderStaffTable();
    renderCertTables();
    renderParades();
    renderReports();
    renderInfo();
    showCertTab('attest');
    showTab('dashboard');
};

// ...existing
// ...existing code...

// --- Удаление и редактирование блоков информации (только для руководства) ---
function deleteInfo(id) {
    if (!['Начальник ОРЛС','Зам Начальника ОРЛС'].includes(db.user.role)) return;
    if (confirm('Удалить информационный блок?')) {
        db.info = db.info.filter(i => i.id !== id);
        saveDB();
        renderInfo();
    }
}

// --- Кнопка удаления блока информации ---
function infoRowActions(info) {
    let actions = '';
    if ((db.user.role === 'Начальник ОРЛС' || db.user.role === 'Зам Начальника ОРЛС') && info.createdBy === db.user.nickname) {
        actions += `<button onclick="editInfo('${info.id}')" class="bg-blue-500 text-white px-2 py-1 rounded mt-2">Редактировать</button>`;
        actions += `<button onclick="deleteInfo('${info.id}')" class="bg-red-500 text-white px-2 py-1 rounded mt-2 ml-2">Удалить</button>`;
    }
    return actions;
}

// --- Перерисовка информационных блоков с действиями ---
function renderInfo() {
    const blocks = db.info.map(i => `
        <div class="mb-4 p-4 border rounded">
            <h4 class="font-bold">${i.title}</h4>
            <div>${i.content}</div>
            ${infoRowActions(i)}
        </div>
    `).join('');
    document.getElementById('infoBlocks').innerHTML = blocks;
}

// --- Удаление строя (только автор может удалить) ---
function deleteParade(id) {
    const parade = db.parades.find(p => p.id === id);
    if (parade && parade.createdBy === db.user.nickname) {
        if (confirm('Удалить строй?')) {
            db.parades = db.parades.filter(p => p.id !== id);
            saveDB();
            renderParades();
            renderDashboard();
        }
    }
}

// --- Кнопка удаления строя в списке ---
function paradeRowActions(parade) {
    let actions = '';
    if (parade.createdBy === db.user.nickname) {
        actions += `<button onclick="editParade('${parade.id}')" class="bg-blue-500 text-white px-2 py-1 rounded">Редактировать</button>`;
        actions += `<button onclick="deleteParade('${parade.id}')" class="bg-red-500 text-white px-2 py-1 rounded ml-2">Удалить</button>`;
    }
    return actions;
}

// ...existing code...

// --- Автоматическая очистка строев в 00:00 по Москве ---
function autoClearParades() {
    setInterval(() => {
        const now = new Date();
        if (now.getHours() === 0 && now.getMinutes() === 0) {
            db.parades = [];
            saveDB();
            renderParades();
            renderDashboard();
        }
    }, 60000);
}

// --- Переключение между разделами аттестаций ---
function showCertTab(tab) {
    document.getElementById('certAttest').style.display = tab === 'attest' ? '' : 'none';
    document.getElementById('certRetest').style.display = tab === 'retest' ? '' : 'none';
    renderCertTables();
}

// --- Переключение вкладок ---
function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    if (tab === 'staff') renderStaffTable();
    if (tab === 'certifications') renderCertTables();
    if (tab === 'parades') renderParades();
    if (tab === 'reports') renderReports();
    if (tab === 'info') renderInfo();
    if (tab === 'dashboard') renderParades();
}

// --- Модальные окна ---
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// --- Выход из системы ---
function logout() {
    localStorage.removeItem('panelDB');
    location.reload();
}

// --- Главная страница (отображение строев) ---
function renderDashboard() {
    document.getElementById('paradeList').innerHTML = db.parades.length
        ? db.parades.map(p => `<div class="mb-2 p-2 border rounded"><b>${p.department}</b> — ${p.paradeTime}<br>${p.paradeText}</div>`).join('')
        : '<div class="text-gray-500">Нет предстоящих строев.</div>';
}

// --- Инициализация автоматической очистки строев ---
autoClearParades();

// ...existing code...

// --- Вспомогательные функции для уведомлений ---
function showNotification(message, type = 'info') {
    let notif = document.createElement('div');
    notif.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-lg text-white ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600'}`;
    notif.textContent = message;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2500);
}

// --- Проверка заполнения обязательных полей формы ---
function validateForm(formId, requiredFields) {
    const form = document.getElementById(formId);
    for (let field of requiredFields) {
        if (!form[field].value.trim()) {
            showNotification(`Поле "${form[field].placeholder || field}" обязательно!`, 'error');
            return false;
        }
    }
    return true;
}

// --- Пример использования в форме добавления сотрудника ---
document.getElementById('staffForm').onsubmit = function(e) {
    e.preventDefault();
    if (!validateForm('staffForm', ['nickname', 'role', 'rank', 'position'])) return;
    // ...добавление сотрудника...
    showNotification('Сотрудник добавлен!', 'success');
};

// --- Поиск сотрудника по нику (быстрый доступ) ---
function quickFindStaff(nick) {
    const staff = db.staff.find(s => s.nickname.toLowerCase() === nick.toLowerCase());
    if (staff) {
        showTab('staff');
        document.getElementById('staffFilter').value = staff.nickname;
        renderStaffTable();
        showNotification(`Найден сотрудник: ${staff.nickname}`, 'success');
    } else {
        showNotification('Сотрудник не найден!', 'error');
    }
}

// --- Горячая клавиша для быстрого поиска (Ctrl+F) ---
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        let nick = prompt('Введите ник сотрудника для поиска:');
        if (nick) quickFindStaff(nick);
    }
});

// --- Сортировка сотрудников по званию ---
function sortStaffByRank() {
    db.staff.sort((a, b) => a.rank.localeCompare(b.rank));
    renderStaffTable();
    showNotification('Сотрудники отсортированы по званию');
}

// --- Кнопка сортировки в разделе сотрудников ---
const sortBtn = document.createElement('button');
sortBtn.textContent = 'Сортировать по званию';
sortBtn.className = 'bg-gray-400 text-white py-2 px-4 rounded-lg mb-4 ml-2';
sortBtn.onclick = sortStaffByRank;
document.getElementById('staff').insertBefore(sortBtn, document.getElementById('staff').children[2]);

// --- Подсказки для пользователей ---
function showHelp() {
    alert(
        'Подсказки:\n' +
        '- Для быстрого поиска сотрудника нажмите Ctrl+F\n' +
        '- Для сортировки сотрудников используйте кнопку над таблицей\n' +
        '- Для добавления информации, отчета, неактива используйте соответствующие кнопки\n' +
        '- Руководство может редактировать и удалять сотрудников, строи и информационные блоки\n' +
        '- Строи автоматически очищаются в 00:00 по Москве'
    );
}
const helpBtn = document.createElement('button');
helpBtn.textContent = 'Помощь';
helpBtn.className = 'bg-yellow-400 text-white py-2 px-4 rounded-lg mb-4 ml-2';
helpBtn.onclick = showHelp;
document.getElementById('sidebar').appendChild(helpBtn);

// --- Адаптация интерфейса под мобильные устройства ---
function adaptMobile() {
    if (window.innerWidth < 700) {
        document.querySelector('.sidebar').style.width = '100px';
        document.querySelector('.main-content').style.width = 'calc(100% - 100px)';
        document.querySelectorAll('.sidebar nav ul li a').forEach(a => a.style.fontSize = '12px');
    } else {
        document.querySelector('.sidebar').style.width = '250px';
        document.querySelector('.main-content').style.width = 'calc(100% - 250px)';
        document.querySelectorAll('.sidebar nav ul li a').forEach(a => a.style.fontSize = '');
    }
}
window.addEventListener('resize', adaptMobile);
adaptMobile();

// --- Подсветка активной вкладки ---
function highlightActiveTab(tab) {
    document.querySelectorAll('.sidebar nav ul li a').forEach(a => a.classList.remove('bg-blue-900'));
    const links = document.querySelectorAll('.sidebar nav ul li a');
    links.forEach(a => {
        if (a.getAttribute('onclick') && a.getAttribute('onclick').includes(tab)) {
            a.classList.add('bg-blue-900');
        }
    });
}
function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    highlightActiveTab(tab);
    if (tab === 'staff') renderStaffTable();
    if (tab === 'certifications') renderCertTables();
    if (tab === 'parades') renderParades();
    if (tab === 'reports') renderReports();
    if (tab === 'info') renderInfo();
    if (tab === 'dashboard') renderParades();
}

// ...existing

// --- Перерисовка строев с действиями ---
function renderParades() {
    document.getElementById('paradesTable').innerHTML = db.parades.map(p => `
        <li class="mb-2 p-2 border rounded flex justify-between items-center">
            <div>
                <b>${p.department}</b> — ${p.paradeTime}<br>${p.paradeText}
            </div>
            ${paradeRowActions(p)}
        </li>
    `).join('');
    document.getElementById('paradeList').innerHTML = db.parades.length
        ? db.parades.map(p => `<div class="mb-2 p-2 border rounded"><b>${p.department}</b> — ${p.paradeTime}<br>${p.paradeText}</div>`).join('')
        : '<div class="text-gray-500">Нет предстоящих строев.</div>';
}

// --- Итог по переаттестации (только руководство может менять итог) ---
function setRetestFinal(id, value) {
    const r = db.certRetest.find(rt => rt.id === id);
    if (r && ['Начальник ОРЛС','ГУ ГИБДД'].includes(db.user.role)) {
        r.final = value;
        saveDB();
        renderCertTables();
    }
}

// --- Кнопка смены итога в переаттестациях ---
function retestFinalActions(retest) {
    if (['Начальник ОРЛС','ГУ ГИБДД'].includes(db.user.role)) {
        return `
            <select onchange="setRetestFinal('${retest.id}', this.value)" class="ml-2 p-1 border rounded">
                <option value="Ожидает" ${retest.final==="Ожидает"?"selected":""}>Ожидает</option>
                <option value="Уволен" ${retest.final==="Уволен"?"selected":""}>Уволен</option>
                <option value="Сдал" ${retest.final==="Сдал"?"selected":""}>Сдал</option>
                <option value="По собственному желанию" ${retest.final==="По собственному желанию"?"selected":""}>По собственному желанию</option>
            </select>
        `;
    }
    return '';
}

// --- Перерисовка переаттестаций с итогом для руководства ---
function renderCertTables() {
    const filter = document.getElementById('certFilter').value.toLowerCase();
    document.getElementById('certAttest').innerHTML = db.certAttest
        .filter(a => a.nickname.toLowerCase().includes(filter))
        .map(a => `
            <div class="mb-2 p-2 border rounded flex justify-between items-center">
                <div>
                    <b>${a.nickname}</b> (${a.acceptedBy}) — ${a.date} — ${a.attempt} попытка — <span class="${a.result==='Сдал'?'text-green-600':'text-red-600'}">${a.result}</span>
                    <a href="${a.proof}" target="_blank" class="text-blue-600 underline ml-2">Доказательство</a>
                </div>
                ${canEditAttest(a) ? `<button onclick="editAttest('${a.id}')" class="bg-blue-500 text-white px-2 py-1 rounded">Редактировать</button>` : ''}
            </div>
        `).join('');
    document.getElementById('certRetest').innerHTML = db.certRetest
        .filter(r => r.nickname.toLowerCase().includes(filter))
        .map(r => `
            <div class="mb-2 p-2 border rounded flex justify-between items-center">
                <div>
                    <b>${r.nickname}</b> — ${r.date} — Нарушил: ${r.violation||'-'} — ${r.attempt} попытка — Итог: <span class="font-bold">${r.final}</span>
                    <a href="${r.proof}" target="_blank" class="text-blue-600 underline ml-2">Доказательство</a>
                    ${retestFinalActions(r)}
                </div>
                ${canEditRetest(r) ? `<button onclick="editRetest('${r.id}')" class="bg-purple-500 text-white px-2 py-1 rounded">Редактировать</button>` : ''}
            </div>
        `).join('');
}
// Пример: populateRoleSelects() для модального окна добавления сотрудника
function populateRoleSelects() {
    const select = document.querySelector('#addStaffModal select[name="role"]');
    select.innerHTML = '';
    ['Начальник ОРЛС','ГУ ГИБДД','Зам Начальника ОРЛС','Старший Инструктор ОРЛС','Инструктор ОРЛС','Стажер ОРЛС'].forEach(role => {
        const option = document.createElement('option');
        option.value = role;
        option.textContent = role;
        select.appendChild(option);
    });
}
window.onload = function() {
    populateRoleSelects();
    renderUserSidebar();
    renderStaffTable();
    renderCertTables();
    renderParades();
    renderReports();
    renderInfo();
    showCertTab('attest');
    showTab('dashboard');
};
</script>
</body>
</html>
